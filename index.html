<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NetBongo - Premium Video Streaming</title>
    <meta name="description" content="Watch high quality videos on NetBongo.">
    
    <!-- Open Graph for Sharing -->
    <meta property="og:site_name" content="NetBongo">
    <meta property="og:title" content="NetBongo Video Player">
    <meta property="og:description" content="Watch this video now on NetBongo">
    <meta property="og:image" content="https://via.placeholder.com/1200x630?text=Play+Video">
    <meta property="og:type" content="video.other">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ADSTERRA: Popunder -->
    <script src="https://momrollback.com/02/f8/86/02f886f4ac6dd52755b96f56e54b4d57.js"></script>
    
    <!-- ADSTERRA: Social Bar -->
    <script src="https://momrollback.com/dc/95/4d/dc954dbecf4b21d37cedb37de585cf99.js"></script>

    <style>
        :root {
            --primary: #ff9000; /* Tube Orange */
            --bg-dark: #000000;
            --bg-card: #1b1b1b;
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --border: #333333;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            padding-bottom: 60px; /* Space for sticky ads if any */
        }

        /* Header */
        header {
            background: #111;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.7);
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
            cursor: pointer;
            text-decoration: none;
            color: white;
        }
        .logo span {
            background: var(--primary);
            color: black;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 2px;
        }

        /* 18+ Modal */
        #adult-warning {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        .warning-box {
            border: 2px solid var(--primary);
            padding: 30px;
            border-radius: 10px;
            background: #111;
            max-width: 400px;
        }
        .enter-btn {
            background: var(--primary);
            color: black;
            font-weight: bold;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 20px;
            text-transform: uppercase;
        }

        /* Layout Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Ads */
        .native-ad {
            width: 100%;
            min-height: 100px;
            background: #0f0f0f;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .banner-ad {
            margin: 20px auto;
            text-align: center;
            display: flex;
            justify-content: center;
        }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        @media (max-width: 600px) {
            .video-grid {
                grid-template-columns: 1fr; /* Full width on mobile for larger thumbnails */
            }
        }

        .video-card {
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .video-card:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(255,144,0,0.2); }

        .thumb-box {
            position: relative;
            padding-top: 56.25%; /* 16:9 */
            background: #000;
        }
        .thumb-img {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
        }
        .badge {
            position: absolute;
            bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 5px;
            font-size: 11px;
            border-radius: 2px;
            font-weight: bold;
        }
        
        .card-info { padding: 10px; }
        .card-title {
            font-size: 15px;
            font-weight: 500;
            margin: 0;
            line-height: 1.3;
            color: #ddd;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-meta {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        /* Player View */
        #player-view { display: none; }
        
        .player-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .player-layout { grid-template-columns: 1fr; }
        }

        .player-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 50;
        }

        .artplayer-app { width: 100%; height: 100%; }

        .video-details {
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        .main-title { font-size: 20px; margin: 0 0 10px 0; color: white; }
        
        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #333;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }
        .btn:hover { background: #444; }
        .btn.primary { background: var(--primary); color: black; font-weight: bold; }
        .btn.smart { background: #28a745; color: white; } /* Green for download/smartlink */

        /* Playlist (M3U sidebar) */
        .playlist-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            max-height: 500px;
            overflow-y: auto;
            border-radius: 4px;
        }
        .playlist-header {
            padding: 10px;
            background: #222;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
        }
        .playlist-item {
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .playlist-item:hover, .playlist-item.active { background: #333; }
        .playlist-item i { color: var(--primary); font-size: 12px; }
        .playlist-item span { font-size: 13px; color: #ccc; }

        /* Loader */
        .loader { text-align: center; padding: 40px; color: var(--primary); font-size: 18px; }

    </style>
</head>
<body>

    <!-- WARNING MODAL -->
    <div id="adult-warning">
        <div class="warning-box">
            <h1 style="color:red; margin-top:0;"><i class="fas fa-exclamation-triangle"></i> WARNING 18+</h1>
            <p>This website contains age-restricted materials.</p>
            <p style="color:#aaa; font-size: 14px;">By entering, you affirm that you are at least 18 years of age or the age of majority in the jurisdiction you reside in.</p>
            <button class="enter-btn" onclick="enterSite()">I am 18+ - Enter</button>
        </div>
    </div>

    <header>
        <div class="logo" onclick="goHome()">Net<span>Bongo</span></div>
        <div style="color: #666; font-size: 12px;"><i class="fas fa-shield-alt"></i> Secure Proxy</div>
    </header>

    <div class="container">
        
        <!-- NATIVE AD (Top) -->
        <div class="native-ad">
            <script async="async" data-cfasync="false" src="https://momrollback.com/b88712e5e1e497d39ecedaffd47492bc/invoke.js"></script>
            <div id="container-b88712e5e1e497d39ecedaffd47492bc"></div>
        </div>

        <!-- HOME VIEW -->
        <div id="home-view">
            <div id="grid-container" class="video-grid">
                <!-- Videos injected here -->
            </div>
            <div id="loader" class="loader"><i class="fas fa-circle-notch fa-spin"></i> Loading content...</div>
        </div>

        <!-- PLAYER VIEW -->
        <div id="player-view">
            <button class="btn" onclick="goHome()" style="margin-bottom: 15px;"><i class="fas fa-arrow-left"></i> Back to Home</button>

            <div class="player-layout">
                <!-- Left: Player -->
                <div class="main-content">
                    <div class="player-wrapper">
                        <div class="artplayer-app" id="artplayer"></div>
                    </div>

                    <div class="video-details">
                        <h1 class="main-title" id="video-title">Loading...</h1>
                        <div class="action-bar">
                            <button class="btn primary" onclick="copyLink()"><i class="fas fa-share-alt"></i> Share</button>
                            <a href="https://momrollback.com/jnt0mwiv7?key=c244b66638c840b3570508593d8b468e" target="_blank" class="btn smart">
                                <i class="fas fa-download"></i> HD Download
                            </a>
                            <button class="btn" onclick="toggleCinema()"><i class="fas fa-expand"></i> Cinema Mode</button>
                        </div>
                        <div id="copy-msg" style="color: var(--primary); font-size: 12px; margin-top: 5px; display: none;">Link copied to clipboard!</div>
                    </div>

                    <!-- 300x250 AD (Below Player) -->
                    <div class="banner-ad">
                        <script type="text/javascript">
                            atOptions = { 'key' : 'efc3a9ebdeba69b64a361554582f3008', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
                        </script>
                        <script type="text/javascript" src="https://momrollback.com/efc3a9ebdeba69b64a361554582f3008/invoke.js"></script>
                    </div>
                </div>

                <!-- Right: Playlist / Related -->
                <div class="sidebar">
                    <div id="playlist-container" class="playlist-box" style="display:none;">
                        <div class="playlist-header">Playlist / Episodes</div>
                        <div id="playlist-items"></div>
                    </div>
                    
                    <!-- Fallback content if no playlist: More Ads or Random Videos could go here -->
                    <div style="margin-top: 20px; text-align:center; color:#444; font-size:12px;">
                        ADVERTISEMENT
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // CONFIG
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTugOQXwLIGyVofFlvFLKN7E_PNemCkIDcdwB4dGcoP16gOnTcmJ2iSM5lr_YFVPts1Fbc5g5gkvE4S/pub?output=csv";
        const PROXY_URL = "https://netbong.aiorbd.workers.dev/?url=";
        
        let allVideos = [];
        let art = null;
        let hlsInstance = null;
        let currentPlaylist = [];

        // 1. INIT & CONSENT
        document.addEventListener("DOMContentLoaded", () => {
            if(localStorage.getItem('netbongo_adult') === 'true') {
                document.getElementById('adult-warning').style.display = 'none';
                loadContent();
            }
        });

        function enterSite() {
            localStorage.setItem('netbongo_adult', 'true');
            document.getElementById('adult-warning').style.display = 'none';
            loadContent();
        }

        // 2. LOAD DATA (Proxy Fallback Logic)
        async function fetchWithFallback(url) {
            try {
                // Try direct first (if CORS allowed)
                const res = await fetch(url);
                if (!res.ok) throw new Error("Direct fail");
                return await res.text();
            } catch (e) {
                // Use Proxy
                console.log("Using Proxy for: " + url);
                const res = await fetch(PROXY_URL + encodeURIComponent(url));
                return await res.text();
            }
        }

        async function loadContent() {
            try {
                const csvText = await fetchWithFallback(CSV_URL);
                const result = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                
                // Filter and Randomize
                allVideos = result.data.filter(v => v.url && v.title);
                allVideos.sort(() => Math.random() - 0.5);

                // Check URL params
                const params = new URLSearchParams(window.location.search);
                const sharedUrl = params.get('v');
                
                if(sharedUrl) {
                    const found = allVideos.find(v => v.url === sharedUrl) || { title: "Shared Video", url: sharedUrl, type: 'auto' };
                    initPlayerPage(found);
                } else {
                    renderGrid(allVideos);
                }
            } catch (err) {
                document.getElementById('loader').innerHTML = "Error loading content. Please refresh.";
                console.error(err);
            }
        }

        // 3. RENDER HOME GRID
        function renderGrid(videos) {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            document.getElementById('loader').style.display = 'none';
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('player-view').style.display = 'none';

            videos.forEach(video => {
                const div = document.createElement('div');
                div.className = 'video-card';
                // Improve image logic
                let imgUrl = video.image && video.image.trim() !== '' ? video.image : 'https://via.placeholder.com/320x180/111/ff9000?text=NetBongo';
                
                div.innerHTML = `
                    <div class="thumb-box">
                        <img src="${imgUrl}" class="thumb-img" loading="lazy" onerror="this.src='https://via.placeholder.com/320x180?text=Error'">
                        <span class="badge">${video.type || 'HD'}</span>
                    </div>
                    <div class="card-info">
                        <h3 class="card-title">${video.title}</h3>
                        <div class="card-meta">
                            <span><i class="fas fa-eye"></i> ${Math.floor(Math.random() * 50000) + 1000}</span>
                            <span>100%</span>
                        </div>
                    </div>
                `;
                div.onclick = () => initPlayerPage(video);
                container.appendChild(div);
            });
        }

        // 4. PLAYER PAGE LOGIC
        async function initPlayerPage(video) {
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('player-view').style.display = 'block';
            document.getElementById('video-title').innerText = video.title;
            
            // Scroll top
            window.scrollTo({top: 0, behavior: 'smooth'});

            // URL Update
            const newUrl = `${window.location.pathname}?v=${encodeURIComponent(video.url)}`;
            window.history.pushState({ path: newUrl }, '', newUrl);
            document.title = `Watch: ${video.title} - NetBongo`;

            // Reset Playlist UI
            document.getElementById('playlist-container').style.display = 'none';
            document.getElementById('playlist-items').innerHTML = '';

            // Destroy previous player
            if (art) { art.destroy(false); art = null; }
            if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }

            // LOGIC: Is it M3U Playlist or Direct Video?
            const isM3U = (video.type && video.type.toLowerCase() === 'm3u') || video.url.endsWith('.m3u');
            
            if (isM3U && !video.url.endsWith('.m3u8')) {
                // It's a playlist file
                await handleM3UPlaylist(video.url);
            } else {
                // Single Video (mp4 or m3u8)
                initArtPlayer(video.url, video.image);
            }
        }

        // 5. M3U PARSER (For Playlist Sidebars)
        async function handleM3UPlaylist(url) {
            document.getElementById('playlist-container').style.display = 'block';
            document.getElementById('playlist-items').innerHTML = '<div style="padding:10px; color:#888;">Parsing Playlist...</div>';

            try {
                const text = await fetchWithFallback(url);
                const lines = text.split('\n');
                currentPlaylist = [];
                let tempTitle = "Episode";

                // Basic M3U Parser
                lines.forEach(line => {
                    line = line.trim();
                    if (line.startsWith('#EXTINF:')) {
                        // Extract title from EXTINF
                        const parts = line.split(',');
                        tempTitle = parts[1] || "Episode";
                    } else if (line.length > 0 && !line.startsWith('#')) {
                        currentPlaylist.push({ title: tempTitle, url: line });
                        tempTitle = "Episode " + (currentPlaylist.length + 1); // Reset default
                    }
                });

                renderPlaylistUI();
                
                // Auto play first
                if (currentPlaylist.length > 0) {
                    initArtPlayer(currentPlaylist[0].url);
                    highlightPlaylistItem(0);
                }
            } catch (e) {
                console.error(e);
                alert("Failed to load playlist. Try refreshing.");
            }
        }

        function renderPlaylistUI() {
            const container = document.getElementById('playlist-items');
            container.innerHTML = '';
            currentPlaylist.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                div.id = `plist-${idx}`;
                div.innerHTML = `<i class="fas fa-play-circle"></i> <span>${idx+1}. ${item.title}</span>`;
                div.onclick = () => {
                    initArtPlayer(item.url);
                    highlightPlaylistItem(idx);
                };
                container.appendChild(div);
            });
        }

        function highlightPlaylistItem(idx) {
            document.querySelectorAll('.playlist-item').forEach(el => el.classList.remove('active'));
            const el = document.getElementById(`plist-${idx}`);
            if(el) el.classList.add('active');
        }

        // 6. ARTPLAYER + MANUAL QUALITY SETUP
        function initArtPlayer(url, poster) {
            if (art) art.destroy(false);
            
            // Check if we need proxy for the video stream itself (often needed for m3u8 cross-domain)
            // But usually ArtPlayer/HLS handles redirects. If fails, we might need proxy in URL.
            // For now, use direct. If CORS error, ArtPlayer 'error' event can handle it.

            art = new Artplayer({
                container: '#artplayer',
                url: url,
                poster: poster || '',
                volume: 0.7,
                isLive: false,
                muted: false,
                autoplay: true,
                pip: true,
                autoSize: true,
                autoMini: true,
                screenshot: true,
                setting: true,
                loop: false,
                flip: true,
                playbackRate: true,
                aspectRatio: true,
                fullscreen: true,
                fullscreenWeb: true,
                miniProgressBar: true,
                mutex: true,
                backdrop: true,
                playsInline: true,
                theme: '#ff9000',
                lang: navigator.language.toLowerCase(),
                customType: {
                    m3u8: function (video, url, art) {
                        if (Hls.isSupported()) {
                            if (hlsInstance) hlsInstance.destroy();
                            hlsInstance = new Hls();
                            hlsInstance.loadSource(url);
                            hlsInstance.attachMedia(video);
                            
                            // MANUAL QUALITY SWITCHING LOGIC
                            hlsInstance.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                                const levels = data.levels.map((level, index) => {
                                    return {
                                        html: level.height + 'P', // e.g., 720P
                                        index: index,
                                        url: url // Keep same URL, HLS switches internally
                                    };
                                });
                                
                                // Default to Auto if possible, or add Auto option
                                levels.unshift({ html: 'Auto', index: -1, default: true });

                                art.controls.add({
                                    name: 'quality',
                                    index: 10,
                                    position: 'right',
                                    html: 'Auto', // Initial Text
                                    selector: levels,
                                    onSelect: function (item) {
                                        hlsInstance.currentLevel = item.index;
                                        return item.html;
                                    },
                                });
                            });
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        } else {
                            art.notice.show = 'Unsupported video format';
                        }
                    },
                },
            });

            // Error Recovery
            art.on('error', (error) => {
                console.log('Video error, trying proxy...');
                if (!url.includes(PROXY_URL)) {
                    art.switchUrl(PROXY_URL + encodeURIComponent(url));
                }
            });
        }

        // 7. UTILS
        function goHome() {
            document.getElementById('player-view').style.display = 'none';
            document.getElementById('home-view').style.display = 'block';
            if (art) art.pause();
            
            // Clean URL
            const cleanUrl = window.location.pathname;
            window.history.pushState({ path: cleanUrl }, '', cleanUrl);
            document.title = "NetBongo - Premium Video Streaming";
        }

        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const msg = document.getElementById('copy-msg');
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
            });
        }

        function toggleCinema() {
            // Simple visual toggle (optional)
            const playerView = document.getElementById('player-view');
            playerView.classList.toggle('cinema-mode');
            // Can add CSS to dim background further
        }

        // Handle Browser Back Button
        window.onpopstate = () => {
            const params = new URLSearchParams(window.location.search);
            if (!params.get('v')) {
                goHome();
            } else {
                location.reload(); // Simplest way to ensure correct state reload
            }
        };

    </script>
</body>
</html>

